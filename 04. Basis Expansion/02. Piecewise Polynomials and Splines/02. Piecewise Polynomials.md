## Piecewise Polynomials: Local Adaptability in Basis Expansions

```mermaid
graph LR
    subgraph "Piecewise Polynomial Concept"
        direction TB
        A["Input Variable X"]
        B["Response Variable Y"]
        C["Piecewise Polynomial Function: 'f(X)'"]
        D["Polynomial Segment 1"]
        E["Polynomial Segment 2"]
        F["Polynomial Segment K"]
        G["Knot 1"]
        H["Knot 2"]
        I["Knot K-1"]
        A --> C
        C --> D
        C --> E
        C --> F
        D -- "Defined on interval before" --> G
        E -- "Defined on interval between" --> G & H
        F -- "Defined on interval after" --> I
    end
```

### Introdu√ß√£o

As *basis expansions*, como explorado anteriormente, oferecem uma maneira flex√≠vel de estender a capacidade de modelos lineares ao transformar as features originais por meio de fun√ß√µes de base. Dentre as diversas op√ß√µes de fun√ß√µes de base, os **piecewise polynomials** destacam-se pela sua capacidade de modelar rela√ß√µes n√£o lineares complexas, mantendo a flexibilidade local. Piecewise polynomials s√£o fun√ß√µes formadas por segmentos polinomiais de baixo grau (como linhas, par√°bolas ou c√∫bicas) que s√£o definidos em intervalos separados, juntando-se para formar uma fun√ß√£o cont√≠nua ou, em alguns casos, descont√≠nua.

Este cap√≠tulo se concentra em piecewise polynomials, examinando como eles s√£o constru√≠dos, quais s√£o suas propriedades e como eles podem ser usados para construir modelos com alta flexibilidade e adaptabilidade local, conceitos importantes no contexto de *basis expansions* [^5.2].

### Defini√ß√£o e Constru√ß√£o de Piecewise Polynomials

Um **piecewise polynomial** √© uma fun√ß√£o composta por segmentos polinomiais que s√£o definidos em intervalos cont√≠guos e que s√£o unidos em pontos espec√≠ficos denominados **n√≥s** (knots). Cada segmento polinomial √© geralmente de baixo grau (como linear, quadr√°tico ou c√∫bico) [^5.2]. A fun√ß√£o resultante √© cont√≠nua se os segmentos se juntam sem descontinuidade, mas tamb√©m podem ser constru√≠das fun√ß√µes que permitem descontinuidades nos n√≥s.

Formalmente, um piecewise polynomial $f(X)$ pode ser definido como:

$$
f(X) = \begin{cases}
    p_1(X), & \text{se } X < \xi_1 \\
    p_2(X), & \text{se } \xi_1 \leq X < \xi_2 \\
    \vdots \\
    p_k(X), & \text{se } \xi_{k-1} \leq X < \xi_k \\
    \vdots \\
    p_K(X), & \text{se } X \geq \xi_{K-1}
\end{cases}
$$

onde $p_i(X)$ s√£o polin√¥mios de grau menor ou igual a um grau m√°ximo pr√©-definido, e $\xi_1, \xi_2, \ldots, \xi_{K-1}$ s√£o os n√≥s. A escolha do n√∫mero e da localiza√ß√£o dos n√≥s e do grau dos polin√¥mios influencia a forma e a flexibilidade do piecewise polynomial resultante.

```mermaid
graph LR
    subgraph "Piecewise Polynomial Definition"
        direction TB
        A["'f(X)'"]
        B["'p_1(X)' if 'X < Œæ_1'"]
        C["'p_2(X)' if 'Œæ_1 ‚â§ X < Œæ_2'"]
        D["'p_k(X)' if 'Œæ_{k-1} ‚â§ X < Œæ_k'"]
        E["'p_K(X)' if 'X ‚â• Œæ_{K-1}'"]
        A --> B
        A --> C
        A --> D
        A --> E
    end
```

As fun√ß√µes de base que definem o piecewise polynomial podem ser constru√≠das de diversas formas, utilizando fun√ß√µes indicadoras que definem cada intervalo ou fun√ß√µes *truncated power* que garantem continuidade nos n√≥s. Por exemplo, as seguintes fun√ß√µes representam uma base piecewise linear:

$$ h_1(X) = 1, h_2(X) = X, h_3(X) = (X - \xi_1)_+, h_4(X) = (X - \xi_2)_+$$

onde $(X - \xi)_+$ representa a parte positiva da express√£o, ou seja, √© igual a $(X - \xi)$ quando $X \ge \xi$ e 0 caso contr√°rio. As fun√ß√µes $h_3(X)$ e $h_4(X)$ s√£o respons√°veis por adicionar flexibilidade local nos n√≥s $\xi_1$ e $\xi_2$, respectivamente.

> üí° **Exemplo Num√©rico:**
>
> Vamos considerar um exemplo com dois n√≥s, $\xi_1 = 3$ e $\xi_2 = 7$. As fun√ß√µes de base seriam:
>
> - $h_1(X) = 1$
> - $h_2(X) = X$
> - $h_3(X) = (X - 3)_+$
> - $h_4(X) = (X - 7)_+$
>
> Se tivermos um valor de $X = 5$, as fun√ß√µes de base resultariam em:
>
> - $h_1(5) = 1$
> - $h_2(5) = 5$
> - $h_3(5) = (5 - 3)_+ = 2$
> - $h_4(5) = (5 - 7)_+ = 0$
>
> Agora, se tivermos um valor de $X = 8$, as fun√ß√µes de base resultariam em:
>
> - $h_1(8) = 1$
> - $h_2(8) = 8$
> - $h_3(8) = (8 - 3)_+ = 5$
> - $h_4(8) = (8 - 7)_+ = 1$
>
> Podemos ver como $h_3(X)$ come√ßa a ter um valor n√£o nulo ap√≥s o n√≥ $\xi_1 = 3$ e $h_4(X)$ ap√≥s o n√≥ $\xi_2 = 7$. Isso demonstra como as fun√ß√µes de base *truncated power* adicionam flexibilidade local ao modelo.

```mermaid
graph LR
    subgraph "Piecewise Linear Basis Functions"
        direction LR
        A["'h_1(X) = 1'"]
        B["'h_2(X) = X'"]
        C["'h_3(X) = (X - Œæ_1)_+'"]
        D["'h_4(X) = (X - Œæ_2)_+'"]
        E["Input 'X'"]
        E --> A
        E --> B
        E --> C
        E --> D
        C --"introduces local flexibilty at"--> F["Knot 'Œæ_1'"]
         D --"introduces local flexibilty at"-->G["Knot 'Œæ_2'"]
    end
```

Ao combinar esses tipos de fun√ß√µes de base, √© poss√≠vel construir uma variedade de piecewise polynomials com diferentes propriedades, como fun√ß√µes cont√≠nuas, cont√≠nuas com primeira derivada, segunda derivada, etc.

### Propriedades dos Piecewise Polynomials

Piecewise polynomials possuem propriedades que os tornam adequados para diversas aplica√ß√µes de modelagem:

1.  **Flexibilidade Local:** Piecewise polynomials podem capturar varia√ß√µes locais nos dados. Ao ajustar os polin√¥mios em cada regi√£o separadamente, o modelo pode se adaptar √†s diferentes caracter√≠sticas de cada regi√£o. Essa flexibilidade local √© uma vantagem sobre modelos lineares globais, que t√™m um ajuste constante em todo o espa√ßo das features.
2.  **Controle da Complexidade:** O controle da complexidade de um modelo *piecewise polynomial* pode ser atingido ao escolher o grau dos polin√¥mios e a quantidade de n√≥s. Polin√¥mios de baixo grau e um n√∫mero reduzido de n√≥s levam a modelos mais simples, enquanto polin√¥mios de alto grau e muitos n√≥s levam a modelos mais complexos. A escolha adequada da complexidade permite balancear o *tradeoff* vi√©s-vari√¢ncia.
3.  **F√°cil Implementa√ß√£o e Interpreta√ß√£o:** A constru√ß√£o de piecewise polynomials √© relativamente simples e a interpreta√ß√£o dos resultados √© facilitada pela natureza local dos polin√¥mios. O efeito de cada segmento polinomial pode ser interpretado separadamente.
4.  **Continuidade:** As restri√ß√µes nos n√≥s permitem controlar a continuidade da fun√ß√£o resultante. √â poss√≠vel construir fun√ß√µes cont√≠nuas, cont√≠nuas com primeira derivada ou com derivadas de ordem superior, o que pode ser √∫til para modelar dados com diferentes graus de suavidade.
5.  **Adaptabilidade:** A localiza√ß√£o dos n√≥s pode ser adaptada aos dados, permitindo que o modelo se concentre nas regi√µes onde h√° maior varia√ß√£o na rela√ß√£o entre a feature e a vari√°vel de resposta.

A combina√ß√£o dessas propriedades faz de piecewise polynomials uma ferramenta poderosa e vers√°til para modelagem n√£o linear em diversas aplica√ß√µes.

### Tipos de Piecewise Polynomials

1.  **Piecewise Constantes:** S√£o o tipo mais simples de piecewise polynomial, onde cada segmento √© uma constante. A fun√ß√£o √© definida por fun√ß√µes indicadoras, e o modelo se torna uma fun√ß√£o degrau, como mostrado anteriormente. Este tipo de modelo pode capturar descontinuidades nos dados, sendo apropriado para problemas onde a rela√ß√£o entre as features e a resposta muda abruptamente.
$$f(X) = \sum_i \beta_i I(X \in R_i)$$
   onde $R_i$ s√£o as regi√µes definidas por n√≥s.

   > üí° **Exemplo Num√©rico:**
   >
   > Suponha que temos dois n√≥s: $\xi_1 = 3$ e $\xi_2 = 7$, dividindo os dados em tr√™s regi√µes: $R_1: X < 3$, $R_2: 3 \leq X < 7$, e $R_3: X \geq 7$. O modelo piecewise constante seria:
   >
   > $$
   > f(X) = \begin{cases}
   >   \beta_1, & \text{se } X < 3 \\
   >   \beta_2, & \text{se } 3 \leq X < 7 \\
   >   \beta_3, & \text{se } X \geq 7
   > \end{cases}
   > $$
   >
   > Se ajustarmos os par√¢metros para $\beta_1 = 2$, $\beta_2 = 5$ e $\beta_3 = 8$, e se tivermos um valor de $X = 4$, a fun√ß√£o retornaria $f(4) = \beta_2 = 5$. Para $X = 1$, ter√≠amos $f(1) = \beta_1 = 2$ e para $X = 9$, $f(9) = \beta_3 = 8$. Este exemplo ilustra como a fun√ß√£o piecewise constante retorna um valor diferente para cada regi√£o.

```mermaid
graph LR
    subgraph "Piecewise Constant Model"
        direction TB
        A["'f(X)'"]
        B["'Œ≤_1' if 'X < Œæ_1'"]
        C["'Œ≤_2' if 'Œæ_1 ‚â§ X < Œæ_2'"]
        D["'Œ≤_3' if 'X ‚â• Œæ_2'"]
         E["Knot 'Œæ_1'"]
         F["Knot 'Œæ_2'"]
         A --> B
         A --> C
         A --> D
        B -- "Region R1" --> E
         C -- "Region R2" --> E & F
          D -- "Region R3" --> F
    end
```

2. **Piecewise Lineares:** S√£o formados por segmentos lineares, unidas por n√≥s. A fun√ß√£o √© cont√≠nua, e a inclina√ß√£o de cada segmento pode ser diferente.  Modelos piecewise lineares podem ser usados para aproximar fun√ß√µes n√£o lineares suaves e rela√ß√µes que s√£o localmente lineares.
$$ f(X) = \beta_0 + \beta_1 X + \sum_i \beta_i (X - \xi_i)_+ $$
   onde $(X - \xi_i)_+$ representam as partes positivas das dist√¢ncias aos n√≥s.

   > üí° **Exemplo Num√©rico:**
   >
   > Considere um modelo piecewise linear com um n√≥ em $\xi_1 = 5$. A fun√ß√£o seria:
   >
   > $$f(X) = \beta_0 + \beta_1 X + \beta_2 (X - 5)_+$$
   >
   > Suponha que, ap√≥s o ajuste do modelo, os coeficientes sejam: $\beta_0 = 1$, $\beta_1 = 0.5$, e $\beta_2 = 1.2$.
   >
   > Para $X = 3$, temos:
   >
   > $$f(3) = 1 + 0.5 \times 3 + 1.2 \times (3-5)_+ = 1 + 1.5 + 1.2 \times 0 = 2.5$$
   >
   > Para $X = 7$, temos:
   >
   > $$f(7) = 1 + 0.5 \times 7 + 1.2 \times (7-5)_+ = 1 + 3.5 + 1.2 \times 2 = 1 + 3.5 + 2.4 = 6.9$$
   >
   > Este exemplo demonstra como a inclina√ß√£o da fun√ß√£o muda ap√≥s o n√≥ $\xi_1 = 5$, com a contribui√ß√£o de $\beta_2(X - 5)_+$.

```mermaid
graph LR
    subgraph "Piecewise Linear Model"
        direction TB
         A["'f(X) = Œ≤_0 + Œ≤_1 X + Œ£_i Œ≤_i(X - Œæ_i)_+'"]
        B["'Œ≤_0 + Œ≤_1 X' (Global Linear Part)"]
        C["'Œ£_i Œ≤_i(X - Œæ_i)_+' (Local Linear Flexibility)"]
        D["Input X"]
        E["Knot 'Œæ_i'"]
        A --> B
        A --> C
        D --> B
        D --> C
        C -- "Local Flexibity introduced at" --> E
    end
```

3.  **Piecewise C√∫bicos:** S√£o formados por segmentos c√∫bicos, com as derivadas at√© a segunda ordem cont√≠nuas nos n√≥s. Esses modelos oferecem alta flexibilidade e suavidade, sendo adequados para dados com alta curvatura. Este tipo de modelo √© um tipo de spline mais comummente utilizado, e um dos mais utilizados √© o spline c√∫bico natural, que adiciona a restri√ß√£o da segunda derivada ser zero nos limites do dom√≠nio da vari√°vel de entrada.
$$ f(X) = \beta_0 + \beta_1 X + \beta_2 X^2 + \beta_3 X^3 + \sum_i \beta_i (X - \xi_i)^3_+$$

    > üí° **Exemplo Num√©rico:**
    >
    > Vamos considerar um modelo piecewise c√∫bico com um n√≥ em $\xi_1 = 4$. A fun√ß√£o seria:
    >
    > $$f(X) = \beta_0 + \beta_1 X + \beta_2 X^2 + \beta_3 X^3 + \beta_4 (X - 4)^3_+$$
    >
    > Ap√≥s ajustar o modelo, suponha que os coeficientes sejam: $\beta_0 = 2$, $\beta_1 = 1$, $\beta_2 = 0.5$, $\beta_3 = 0.1$ e $\beta_4 = 0.2$.
    >
    > Para $X = 2$:
    >
    > $$f(2) = 2 + 1 \times 2 + 0.5 \times 2^2 + 0.1 \times 2^3 + 0.2 \times (2-4)^3_+ = 2 + 2 + 2 + 0.8 + 0 = 6.8$$
    >
    > Para $X = 6$:
    >
    > $$f(6) = 2 + 1 \times 6 + 0.5 \times 6^2 + 0.1 \times 6^3 + 0.2 \times (6-4)^3_+ = 2 + 6 + 18 + 21.6 + 0.2 \times 8 = 2 + 6 + 18 + 21.6 + 1.6 = 49.2$$
    >
    > Este exemplo mostra como a fun√ß√£o piecewise c√∫bica permite uma modelagem mais complexa e flex√≠vel com a contribui√ß√£o dos termos c√∫bicos e do termo $(X - 4)^3_+$ ap√≥s o n√≥ $\xi_1 = 4$.

```mermaid
graph LR
    subgraph "Piecewise Cubic Model"
        direction TB
        A["'f(X) = Œ≤_0 + Œ≤_1 X + Œ≤_2 X¬≤ + Œ≤_3 X¬≥ + Œ£_i Œ≤_i(X - Œæ_i)¬≥_+'"]
        B["'Œ≤_0 + Œ≤_1 X + Œ≤_2 X¬≤ + Œ≤_3 X¬≥' (Global Cubic Part)"]
         C["'Œ£_i Œ≤_i(X - Œæ_i)¬≥_+' (Local Cubic Flexibility)"]
         D["Input X"]
         E["Knot 'Œæ_i'"]
        A --> B
        A --> C
        D --> B
         D --> C
        C -- "Local Flexibility introduced at" --> E
    end
```

A escolha do tipo de piecewise polynomial depende da complexidade e suavidade das rela√ß√µes entre as features e a vari√°vel resposta. Piecewise constantes s√£o adequadas para modelar dados com descontinuidades, piecewise lineares s√£o adequadas para modelar rela√ß√µes que s√£o localmente lineares, e piecewise c√∫bicos s√£o adequadas para modelar dados com curvatura.

### Splines: Piecewise Polynomials com Continuidade

**Splines** s√£o uma classe especial de piecewise polynomials que s√£o constru√≠dos para garantir a continuidade em certos n√≠veis de derivada nos n√≥s [^5.2]. Os splines mais comuns s√£o os *cubic splines*, onde os segmentos polinomiais s√£o c√∫bicos e a fun√ß√£o resultante √© cont√≠nua, possui primeira e segunda derivadas cont√≠nuas nos n√≥s.

A constru√ß√£o de splines envolve o uso de fun√ß√µes de base espec√≠ficas que garantem a continuidade nas derivadas. Por exemplo, os splines c√∫bicos podem ser constru√≠dos usando fun√ß√µes de *truncated power* ou fun√ß√µes B-spline. Os *truncated power functions* s√£o definidos como $(X - \xi)_+^d$, onde $\xi$ √© o n√≥ e $d$ √© o grau do polin√¥mio. A combina√ß√£o de v√°rios desses termos permite a constru√ß√£o de splines c√∫bicos com a continuidade desejada.

No entanto, fun√ß√µes de *truncated power* podem levar a problemas de instabilidade num√©rica, o que motiva a utiliza√ß√£o de fun√ß√µes B-splines, que s√£o fun√ß√µes de base localmente n√£o nulas, e que se mostram mais est√°veis numericamente e que tamb√©m formam bases para construir splines [^5.2].

Os *natural cubic splines* s√£o splines c√∫bicos que, al√©m das restri√ß√µes de continuidade nos n√≥s, imp√µem restri√ß√µes de linearidade nos limites do dom√≠nio da vari√°vel de entrada. Essa restri√ß√£o reduz o n√∫mero de graus de liberdade do modelo, tornando-o mais adequado em situa√ß√µes com poucos dados [^5.2.1].

Splines s√£o amplamente utilizados em diversas aplica√ß√µes de modelagem, como an√°lise de dados de s√©ries temporais, an√°lise de imagens e modelagem de curvas de crescimento, onde √© importante capturar varia√ß√µes locais e manter um certo n√≠vel de suavidade na fun√ß√£o resultante.

```mermaid
graph LR
    subgraph "Spline Construction"
        direction TB
        A["Spline Function"]
        B["Piecewise Polynomials"]
        C["Continuity Constraints at Knots"]
        D["Truncated Power Basis Functions: '(X - Œæ)_+^d'"]
        E["B-spline Basis Functions"]
        F["Natural Cubic Spline (Linearity at boundaries)"]
        A --> B
        B --> C
        B --> D
        B --> E
        A --> F
        C --> D
        C --> E
        F -- "additional restriction" --> C
    end
```

### Tradeoffs nos Piecewise Polynomials

A utiliza√ß√£o de piecewise polynomials envolve alguns *tradeoffs*:

1.  **Flexibilidade vs. Complexidade:** Piecewise polynomials oferecem grande flexibilidade, mas a escolha do grau dos polin√¥mios e do n√∫mero de n√≥s controla a complexidade do modelo. Um modelo com muitas regi√µes e polin√¥mios de alto grau pode levar a *overfitting*, enquanto um modelo com poucas regi√µes ou polin√¥mios de baixo grau pode subajustar os dados. O n√∫mero ideal de regi√µes e o grau dos polin√¥mios devem ser escolhidos com base em uma avalia√ß√£o do desempenho do modelo e usando valida√ß√£o cruzada, como abordado em [^5.5.2].
2.  **Localiza√ß√£o dos N√≥s:** A localiza√ß√£o dos n√≥s influencia diretamente a capacidade do modelo de capturar varia√ß√µes locais nos dados. N√≥s localizados em √°reas onde h√° maior varia√ß√£o na rela√ß√£o entre as features e a vari√°vel resposta podem melhorar a capacidade do modelo de se ajustar aos dados. A localiza√ß√£o ideal dos n√≥s pode ser obtida atrav√©s de m√©todos de sele√ß√£o de n√≥s ou com o uso de n√≥s uniformemente espa√ßados ao longo do dom√≠nio da vari√°vel de entrada.
3.  **Continuidade vs. Descontinuidade:** A escolha entre fun√ß√µes cont√≠nuas ou descont√≠nuas depende do tipo de rela√ß√µes a serem modeladas. Fun√ß√µes cont√≠nuas s√£o adequadas para modelar rela√ß√µes suaves, enquanto fun√ß√µes descont√≠nuas s√£o adequadas para modelar rela√ß√µes com saltos ou mudan√ßas abruptas. √â importante considerar o efeito da continuidade ou descontinuidade nos n√≥s, j√° que em alguns contextos descontinuidades podem ser apropriadas para capturar efeitos localizados e em outros contextos a suavidade na modelagem √© essencial.

```mermaid
graph LR
    subgraph "Tradeoffs in Piecewise Polynomials"
        direction LR
        A["Flexibility"]
        B["Complexity"]
        C["Number of Regions"]
        D["Degree of Polynomials"]
         E["Knot Location"]
        F["Continuity"]
        G["Discontinuity"]
        A <--> B
        B --> C
        B --> D
        A --> E
        A --> F
        A --> G
    end
```

### Conclus√£o

Os piecewise polynomials oferecem uma poderosa abordagem para modelar rela√ß√µes n√£o lineares em dados unidimensionais, permitindo a constru√ß√£o de modelos que equilibram flexibilidade, interpretabilidade e adaptabilidade local. A capacidade de controlar a complexidade atrav√©s da escolha do grau dos polin√¥mios, do n√∫mero de n√≥s e das restri√ß√µes de continuidade permite que o modelo se adapte a diferentes tipos de dados e de aplica√ß√µes. A compreens√£o dos *tradeoffs* envolvidos √© fundamental para a aplica√ß√£o eficaz dessas fun√ß√µes de base no contexto das *basis expansions*.

### Footnotes

[^5.2]: "Some simple and widely used examples of the hm are the following: $h_m(X) = X^m$, $m = 1, \ldots, p$ recovers the original linear model. $h_m(X) = X_j^2$ or $h_m(X) = X_jX_k$ allows us to augment the inputs with polynomial terms to achieve higher-order Taylor expansions." *(Trecho de <Basis Expansions and Regularization>)*
[^5.2.1]: "A natural cubic spline adds additional constraints, namely that the function is linear beyond the boundary knots." *(Trecho de <Basis Expansions and Regularization>)*
[^5.5.2]: "The fitted splines for three different values of dfx are shown. The yellow shaded region in the figure represents the pointwise standard error of fx, that is, we have shaded the region between $f_x(x) \pm 2 \cdot se(f_x(x))$." *(Trecho de <Basis Expansions and Regularization>)*
